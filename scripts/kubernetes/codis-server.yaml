apiVersion: "apps/v1beta1"
kind: StatefulSet
metadata:
  name: codis-server
spec:
  serviceName: codis-server
  replicas: 2
  template:
    metadata:
      labels:
        app: codis-server
    spec:
      imagePullSecrets:
      - name: cn-registry
      containers:
      - name: codis-server
        image: codis-image:k8s
        imagePullPolicy: IfNotPresent
        command: ["codis-server"]
        args: ["$(CODIS_PATH)/config/redis.conf","--logfile","redis.log","--protected-mode", "no", "--bind", "$(POD_NAME).codis-server.$(POD_NAMESPACE).svc.cluster.local"]
        lifecycle:
          postStart:
            exec:
              command: ["/bin/sh", "-c", "codis-admin --dashboard=codis-dashboard:18080 --reload; if [ $? != 0 ]; then exit 1; fi; \
                        sid=`hostname |awk -F'-' '{print $3}'`;gid=$(expr $sid / ${SERVER_REPLICA} + 1); \
                        local=codis-server-${sid}.codis-server.${POD_NAMESPACE}.svc.cluster.local; \
                        codis-admin --dashboard=codis-dashboard:18080 --create-group --gid=${gid} 1>/dev/null 2>&1; \
                        codis-admin --dashboard=codis-dashboard:18080 --group-add --gid=${gid} --addr=${local}:6379 --permit-check || exit 1; \
                        codis-admin --dashboard=codis-dashboard:18080 --sync-action --create --addr=${local}:6379"]
          preStop:
            exec:
              command: ["/bin/sh", "-c", "codis-admin --dashboard=codis-dashboard:18080 --reload; if [ $? != 0 ]; then exit 1; fi; \
                        sid=`hostname |awk -F'-' '{print $3}'`;gid=$(expr $sid / ${SERVER_REPLICA} + 1); \
                        local=codis-server-${sid}.codis-server.${POD_NAMESPACE}.svc.cluster.local; \
                        codis-admin --dashboard=codis-dashboard:18080 --group-del --gid=${gid} --addr=${local}:6379"]
        env:
        - name: SERVER_REPLICA
          value: "2"
        - name: CODIS_PATH
          value: "/gopath/src/github.com/CodisLabs/codis"
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        ports:
        - containerPort: 6379
          name: service-port
        resources:
          limits:
            cpu: "1"
            memory: 2Gi
          requests:
           cpu: "0.1"
           memory: 0.1Gi
